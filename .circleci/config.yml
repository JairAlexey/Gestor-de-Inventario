version: 2.1

commands:
  setup_python_env:
    description: "Crear entorno virtual e instalar dependencias"
    steps:
      - run:
          name: Setup Python env
          command: |
            python --version
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

jobs:
  build:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - setup_python_env
      - persist_to_workspace:
          root: .
          paths:
            - venv

  lint_test_and_coverage:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Lint + Tests + Coverage.xml
          command: |
            . venv/bin/activate
            flake8
            pytest --maxfail=1 --disable-warnings -q --cov=. --cov-report=xml:coverage.xml
      - persist_to_workspace:
          root: .
          paths:
            - coverage.xml

  sast_sonarqube:
    docker:
      - image: sonarsource/sonar-scanner-cli:latest
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: SAST - SonarCloud Scan (con Coverage)
          command: |
            test -f coverage.xml && echo "coverage.xml OK" || (echo "coverage.xml NO EXISTE" && exit 1)

            sonar-scanner \
              -Dsonar.host.url=$SONAR_HOST_URL \
              -Dsonar.token=$SONAR_TOKEN \
              -Dsonar.scm.disabled=true \
              -Dsonar.python.coverage.reportPaths=coverage.xml \
              -Dsonar.coverage.exclusions="**/migrations/**,**/tests/**,tests/**,**/__pycache__/**,**/venv/**"

  smoke_test:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Smoke Test (local)
          command: |
            . venv/bin/activate
            python manage.py migrate
            python manage.py runserver 127.0.0.1:8000 &
            SERVER_PID=$!
            sleep 5
            curl -L -f http://127.0.0.1:8000/
            kill $SERVER_PID

  dast_zap:
    machine:
      image: ubuntu-2204:current
    environment:
      DAST_TARGET_URL: https://gestor-de-inventario-production.up.railway.app
      DAST_LOGIN_USER: admin
      DAST_LOGIN_PASS: admin123
      DAST_LOGIN_PATH: /login/
      ZAP_REPORT_DIR: reports
      ZAP_PORT: 8080
    steps:
      - checkout
      - run:
          name: DAST - OWASP ZAP Scan (Railway con Autenticaci√≥n)
          command: |
            set -e

            echo "=========================================="
            echo "üï∑Ô∏è  OWASP ZAP DAST - Railway Deployment"
            echo "=========================================="
            echo "Target: $DAST_TARGET_URL"
            echo "User: $DAST_LOGIN_USER"
            echo "=========================================="

            # Verificaci√≥n de conectividad
            echo "1Ô∏è‚É£ Verificando conectividad con Railway..."
            curl -I "$DAST_TARGET_URL" | head -n 10

            # Crear directorio de reportes
            mkdir -p reports
            sudo chmod 777 reports

            echo ""
            echo "2Ô∏è‚É£ Instalando dependencias para autenticaci√≥n..."
            pip install python-owasp-zap-v2.4==0.0.21

            echo ""
            echo "3Ô∏è‚É£ Iniciando ZAP daemon..."
            docker run -d --name zap \
              -u zap \
              -p 8080:8080 \
              -v "$PWD/reports:/zap/wrk:rw" \
              ghcr.io/zaproxy/zaproxy:stable \
              zap.sh -daemon -host 0.0.0.0 -port 8080 \
              -config api.addrs.addr.name=.* \
              -config api.addrs.addr.regex=true \
              -config api.disablekey=true

            echo "‚è≥ Esperando a que ZAP inicie (45s)..."
            sleep 45

            # Verificar que ZAP est√° corriendo
            echo "Verificando ZAP API..."
            for i in {1..10}; do
              if curl -s http://localhost:8080 > /dev/null 2>&1; then
                echo "‚úÖ ZAP API est√° respondiendo"
                break
              fi
              echo "Intento $i/10 - Esperando..."
              sleep 5
            done

            echo ""
            echo "4Ô∏è‚É£ Ejecutando scan con autenticaci√≥n..."
            
            # Ejecutar script Python de autenticaci√≥n
            python security/zap/zap_authenticated_scan.py || {
              echo "‚ö†Ô∏è  Script de autenticaci√≥n complet√≥ con warnings"
              
              # Si falla el script, intentar baseline simple
              echo "Fallback: Ejecutando baseline scan..."
              docker exec zap \
                zap-baseline.py \
                -t "$DAST_TARGET_URL" \
                -J zap-report.json \
                -r zap-report.html \
                -w zap-report.md \
                -d -T 15 || true
            }

            echo ""
            echo "5Ô∏è‚É£ Deteniendo ZAP..."
            docker stop zap || true
            docker rm zap || true

            echo ""
            echo "6Ô∏è‚É£ Verificando archivos generados..."
            echo "Archivos en reports/:"
            ls -lah reports/

            echo ""
            echo "7Ô∏è‚É£ Analizando resultados..."

            # Verificar que los reportes existen
            if [ ! -f "reports/zap-report.json" ]; then
              echo "‚ùå ERROR: No se gener√≥ el reporte JSON"
              echo "Contenido de reports/:"
              ls -la reports/ || true
              echo ""
              echo "Este error puede ocurrir si:"
              echo "1. ZAP no tuvo suficiente tiempo para generar reportes"
              echo "2. Problemas de permisos en el volumen Docker"
              echo "3. ZAP baseline no pudo conectarse al target"
              exit 1
            fi

            # An√°lisis de vulnerabilidades
            echo "üìä Resumen de Alertas:"
            HIGH=$(grep -o '"risk":"High"' reports/zap-report.json | wc -l || echo "0")
            MEDIUM=$(grep -o '"risk":"Medium"' reports/zap-report.json | wc -l || echo "0")
            LOW=$(grep -o '"risk":"Low"' reports/zap-report.json | wc -l || echo "0")
            INFO=$(grep -o '"risk":"Informational"' reports/zap-report.json | wc -l || echo "0")

            echo "  üî¥ High: $HIGH"
            echo "  üü† Medium: $MEDIUM"
            echo "  üü° Low: $LOW"
            echo "  üîµ Info: $INFO"

            # Fallar el build si hay alertas HIGH
            if [ "$HIGH" -gt 0 ]; then
              echo ""
              echo "‚ùå FALLO: Se encontraron $HIGH alertas de riesgo ALTO"
              echo "   Revisa los reportes en los artifacts para m√°s detalles."
              exit 1
            fi

            echo ""
            echo "‚úÖ DAST completado exitosamente"
            echo "=========================================="

      - store_artifacts:
          path: reports
          destination: zap-reports

  build_and_push_image:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker
      - add_ssh_keys:
          fingerprints:
            - "+C9OSm8JLtrL5EIMu5SxED8d0EutXciepRPINtBslow"
      - run:
          name: Build and Push Docker Image
          command: |
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
            docker build -t $DOCKER_USER/gestor-inventario:${CIRCLE_SHA1} .
            docker push $DOCKER_USER/gestor-inventario:${CIRCLE_SHA1}

      - run:
          name: Update Kubernetes Manifest
          command: |
            git config user.email "ci-bot@circleci.com"
            git config user.name "CircleCI Bot"
            sed -i "s|image: .*|image: $DOCKER_USER/gestor-inventario:${CIRCLE_SHA1}|g" k8s/deployment.yaml
            git add k8s/deployment.yaml
            if ! git diff-index --quiet HEAD; then
              git commit -m "Update deployment image to ${CIRCLE_SHA1} [skip ci]"
              git push origin master
            fi

workflows:
  ci_cd_pipeline:
    jobs:
      - build
      - lint_test_and_coverage:
          requires:
            - build
      - sast_sonarqube:
          requires:
            - lint_test_and_coverage
      - smoke_test:
          requires:
            - sast_sonarqube
      - dast_zap:
          requires:
            - smoke_test
      - build_and_push_image:
          requires:
            - dast_zap
          context: docker-hub-credentials
