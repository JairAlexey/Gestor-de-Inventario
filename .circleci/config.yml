version: 2.1

commands:
  setup_venv_and_deps:
    description: "Crear venv, activar e instalar dependencias del proyecto"
    steps:
      - run:
          name: Crear entorno virtual e instalar dependencias
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt || pip install Django pytest pytest-django pytest-cov flake8

  run_migrations:
    description: "Aplicar migraciones Django con settings_ci"
    steps:
      - run:
          name: Ejecutar migrate
          command: |
            . venv/bin/activate
            python manage.py migrate --noinput --settings=gestor_inventario.settings_ci

  install_curl:
    description: "Instalar curl en el container"
    steps:
      - run:
          name: Instalar curl
          command: |
            sudo apt-get update
            sudo apt-get install -y curl

jobs:
  build_and_migrate:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - setup_venv_and_deps
      - run_migrations

  lint_and_test:
    docker:
      - image: cimg/python:3.11
    parallelism: 2
    steps:
      - checkout
      - setup_venv_and_deps
      - run:
          name: Linter y tests
          command: |
            . venv/bin/activate
            flake8
            pytest --maxfail=1 --disable-warnings -q

  smoke_deploy:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - setup_venv_and_deps
      - run_migrations
      - install_curl
      - run:
          name: Levantar servidor y smoke test
          command: |
            . venv/bin/activate
            echo "Iniciando server de prueba..."
            python manage.py runserver 127.0.0.1:8000 --settings=gestor_inventario.settings_ci &
            SERVER_PID=$!
            sleep 5

            echo "Probando endpoint ra√≠z..."
            STATUS=000
            if [ "" != "200" ]; then
              echo "Smoke test fallido (HTTP )"
              kill 
              exit 1
            fi

            echo "Smoke test OK (HTTP 200)"
            kill 
      - run:
          name: Empaquetar artefacto ZIP
          command: |
            zip -r build.zip gestor_inventario tasks manage.py || exit 1
      - store_artifacts:
          path: build.zip
          destination: build.zip

workflows:
  ci_pipeline:
    jobs:
      - build_and_migrate:
          filters:
            branches:
              only:
                - develop
                - master
                - /feature\/.*/
                - /hotfix\/.*/
      - lint_and_test:
          requires:
            - build_and_migrate
          filters:
            branches:
              only:
                - develop
                - master
                - /feature\/.*/
                - /hotfix\/.*/
      - smoke_deploy:
          requires:
            - lint_and_test
          filters:
            branches:
              only:
                - develop
                - master
                - /hotfix\/.*/
