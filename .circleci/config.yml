version: 2.1

jobs:
  build:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - run:
          name: Instalar dependencias
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
      - persist_to_workspace:
          root: .
          paths:
            - venv

  lint_and_test:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Linter (flake8)
          command: |
            . venv/bin/activate
            flake8
      - run:
          name: Tests (pytest)
          command: |
            . venv/bin/activate
            pytest --maxfail=1 --disable-warnings -q

  smoke_test:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Instalar curl
          command: |
            sudo apt-get update
            sudo apt-get install -y curl
      - run:
          name: Smoke Test (Levantar servidor y verificar)
          command: |
            . venv/bin/activate
            # Migración mínima para que la DB local (SQLite) tenga las tablas necesarias
            python manage.py migrate
            
            echo "Iniciando server..."
            python manage.py runserver 127.0.0.1:8000 &
            SERVER_PID=$!
            sleep 5
            
            echo "Verificando endpoint raíz..."
            # Usamos -L para seguir redirecciones (login) y esperar un 200
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" -L http://127.0.0.1:8000/)
            
            if [ "$STATUS" != "200" ]; then
              echo "Fallo: HTTP $STATUS"
              kill $SERVER_PID
              exit 1
            fi
            
            echo "Éxito: HTTP 200"
            kill $SERVER_PID

  build_and_push_image:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker
      - add_ssh_keys:
          fingerprints:
            - "+C9OSm8JLtrL5EIMu5SxED8d0EutXciepRPINtBslow"
      - run:
          name: Construir y subir imagen Docker
          command: |
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
            docker build -t $DOCKER_USER/gestor-inventario:${CIRCLE_SHA1} .
            docker push $DOCKER_USER/gestor-inventario:${CIRCLE_SHA1}
      - run:
          name: Actualizar manifiesto Kubernetes
          command: |
            git config user.email "ci-bot@circleci.com"
            git config user.name "CircleCI Bot"
            
            # Actualizar el tag de la imagen en el archivo deployment.yaml
            sed -i "s|image: .*|image: $DOCKER_USER/gestor-inventario:${CIRCLE_SHA1}|g" k8s/deployment.yaml
            
            # Commitear y pushear si hay cambios
            git add k8s/deployment.yaml
            if ! git diff-index --quiet HEAD; then
              git commit -m "Update deployment image to ${CIRCLE_SHA1} [skip ci]"
              git push origin master
            fi

workflows:
  ci_cd_pipeline:
    jobs:
      - build
      - lint_and_test:
          requires:
            - build
      - smoke_test:
          requires:
            - lint_and_test
      - build_and_push_image:
          requires:
            - smoke_test
          context: docker-hub-credentials # Asegúrate de crear este contexto o usar variables de entorno de proyecto
