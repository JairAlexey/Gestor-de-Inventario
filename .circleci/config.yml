version: 2.1

commands:
  setup_python_env:
    description: "Crear entorno virtual e instalar dependencias"
    steps:
      - run:
          name: Setup Python env
          command: |
            python --version
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

jobs:
  build:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - setup_python_env
      - persist_to_workspace:
          root: .
          paths:
            - venv

  lint_and_test:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Lint and Tests
          command: |
            . venv/bin/activate
            flake8
            pytest --maxfail=1 --disable-warnings -q

  sast_sonarqube:
    docker:
      - image: sonarsource/sonar-scanner-cli:latest
    steps:
      - checkout
      - run:
          name: SAST - SonarQube Scan
          command: |
            sonar-scanner \
              -Dsonar.host.url=$SONAR_HOST_URL \
              -Dsonar.login=$SONAR_TOKEN

  smoke_test:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Smoke Test
          command: |
            . venv/bin/activate
            python manage.py migrate
            python manage.py runserver 127.0.0.1:8000 &
            SERVER_PID=$!
            sleep 5
            curl -L -f http://127.0.0.1:8000/
            kill $SERVER_PID

  dast_arachni:
    machine:
      image: ubuntu-2204:current
    steps:
      - checkout

      - run:
          name: Instalar Python 3.11
          command: |
            sudo apt-get update
            sudo apt-get install -y python3.11 python3.11-venv python3.11-dev
            python3.11 --version

      - run:
          name: Crear venv con Python 3.11
          command: |
            python3.11 -m venv venv
            ./venv/bin/python --version
            ./venv/bin/python -m pip install --upgrade pip
            ./venv/bin/python -m pip install -r requirements.txt

      - run:
          name: DAST - Arachni Scan
          command: |
            ./venv/bin/python manage.py migrate
            ./venv/bin/python manage.py runserver 127.0.0.1:8000 &
            SERVER_PID=$!
            sleep 6

            mkdir -p reports
            docker pull arachni/arachni:latest
            docker run --rm --network host -v "$PWD/reports:/reports" arachni/arachni \
              arachni http://127.0.0.1:8000 \
              --report-save-path=/reports/arachni.afr

            docker run --rm -v "$PWD/reports:/reports" arachni/arachni \
              arachni_reporter /reports/arachni.afr \
              --reporter=html:outfile=/reports/arachni-report.html

            kill $SERVER_PID

      - store_artifacts:
          path: reports
          destination: arachni-reports



  build_and_push_image:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker
      - add_ssh_keys:
          fingerprints:
            - "+C9OSm8JLtrL5EIMu5SxED8d0EutXciepRPINtBslow"
      - run:
          name: Build and Push Docker Image
          command: |
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
            docker build -t $DOCKER_USER/gestor-inventario:${CIRCLE_SHA1} .
            docker push $DOCKER_USER/gestor-inventario:${CIRCLE_SHA1}
      - run:
          name: Update Kubernetes Manifest
          command: |
            git config user.email "ci-bot@circleci.com"
            git config user.name "CircleCI Bot"
            sed -i "s|image: .*|image: $DOCKER_USER/gestor-inventario:${CIRCLE_SHA1}|g" k8s/deployment.yaml
            git add k8s/deployment.yaml
            if ! git diff-index --quiet HEAD; then
              git commit -m "Update deployment image to ${CIRCLE_SHA1} [skip ci]"
              git push origin master
            fi

workflows:
  ci_cd_pipeline:
    jobs:
      - build
      - lint_and_test:
          requires:
            - build
      - sast_sonarqube:
          requires:
            - lint_and_test
      - smoke_test:
          requires:
            - sast_sonarqube
      - dast_arachni:
          requires:
            - smoke_test
      - build_and_push_image:
          requires:
            - dast_arachni
          context: docker-hub-credentials
